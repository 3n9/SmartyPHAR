name: Build Smarty PHARs

on:
  schedule:
    - cron: '0 6 * * 1'   # Every Monday at 06:00 UTC
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Smarty ${{ matrix.smarty_major }}.x PHAR
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        smarty_major: [3, 4, 5]

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: phar
          tools: composer:v2

      - name: Build PHAR
        env:
          SMARTY_MAJOR: ${{ matrix.smarty_major }}
          ALLOW_PHAR_OVERWRITE: '1'
        run: ./build-smarty-phar.sh

      - name: Read resolved Smarty version
        id: version
        run: |
          PHAR=$(ls -t dist/Smarty-v${{ matrix.smarty_major }}.*.phar | head -1)
          VERSION=$(basename "$PHAR" .phar | sed 's/Smarty-v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "phar=$PHAR" >> "$GITHUB_OUTPUT"
          echo "tag=Smarty-v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          ASSET_NAME=$(basename "${{ steps.version.outputs.phar }}")
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            # Release exists – check if the PHAR asset is actually attached
            EXISTING=$(gh release view "$TAG" --repo "$GITHUB_REPOSITORY" \
              --json assets --jq ".assets[] | select(.name == \"$ASSET_NAME\") | .name")
            if [ -n "$EXISTING" ]; then
              echo "exists=true" >> "$GITHUB_OUTPUT"
              echo "Release $TAG with asset $ASSET_NAME already exists – skipping."
            else
              echo "exists=partial" >> "$GITHUB_OUTPUT"
              echo "Release $TAG exists but asset $ASSET_NAME is missing – will upload."
            fi
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release $TAG not found – will create."
          fi

      - name: Create release and upload PHAR
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          PHAR="${{ steps.version.outputs.phar }}"
          VERSION="${{ steps.version.outputs.version }}"
          cat > /tmp/release-notes.md << EOF
          Automated build of Smarty ${VERSION} packaged as a standalone PHAR.

          **Usage:**
          \`\`\`php
          require 'Smarty-v${VERSION}.phar';
          \$smarty = new Smarty\\Smarty();
          \`\`\`

          Built from [smarty/smarty](https://github.com/smarty-php/smarty) via Composer.
          EOF
          gh release create "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --title "Smarty v${VERSION}" \
            --notes-file /tmp/release-notes.md \
            "$PHAR"

      - name: Upload missing asset to existing release
        if: steps.check.outputs.exists == 'partial'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" \
            "${{ steps.version.outputs.phar }}" \
            --repo "$GITHUB_REPOSITORY"

      - name: Skip existing release
        if: steps.check.outputs.exists == 'true'
        run: echo "Release ${{ steps.version.outputs.tag }} already exists – nothing to do."
